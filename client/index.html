<html>
  <head>
    <title>Chinese Poker</title>
    <script src="socket.io.js"></script>
    <script src="fetch.js"></script>
    <script src="cardMap.js"></script>
    <script src="cardSelect.js"></script>
    <script src="actions.js"></script>
    <script>
      const host = 'http://localhost:3000'
      const socket = io(host)

      let player = null
      let selectedCards = []
      let playerTurnId = null

      const join = () => {
        const name = document.getElementById('name-input').value

        if (!name) {
          alert('enter name before you join')
          return
        }

        socket.emit('join', name)
      }

      socket.on('joined', playerInfo => {
        player = playerInfo
      })

      socket.on('gameStarted', players => {
        player = players.find(p => p.id === player.id)

        const playerDeck = document.getElementById('player-deck')
        for (let i in player.cards) {
          const card = player.cards[i]

          const cardElement = document.createElement('div')
          cardElement.classList.add('card')
          cardElement.setAttribute('id', card.category + card.value)
          cardElement.setAttribute('draggable', true)
          cardElement.addEventListener('dragstart', onCardDragStart)
          cardElement.addEventListener('dragover', onCardDragOver)
          cardElement.addEventListener('click', e => {
            toggleSelectCard(card, cardElement)
          })

          const cardImageElement = document.createElement('img')
          cardImageElement.classList.add('card-image')
          cardImageElement.src = 'assets/cards/' + mapCardToAsset(card) + '.jpg'
          cardImageElement.setAttribute('draggable', false)
          cardElement.appendChild(cardImageElement)

          playerDeck.appendChild(cardElement)
        }

        document.getElementById('player-name').innerHTML = player.name

        const opponentId1 = player.id === 4 ? 1 : player.id + 1
        const opponentId2 = opponentId1 === 4 ? 1 : opponentId1 + 1
        const opponentId3 = opponentId2 === 4 ? 1 : opponentId2 + 1

        const opponentDeck1 = document.getElementById('opponent-deck-1')
        const opponentDeck2 = document.getElementById('opponent-deck-2')
        const opponentDeck3 = document.getElementById('opponent-deck-3')

        opponentDeck1.setAttribute('player-id', opponentId1)
        opponentDeck2.setAttribute('player-id', opponentId2)
        opponentDeck3.setAttribute('player-id', opponentId3)

        const opponentTurn1 = document.getElementById('opponent-turn-1')
        const opponentTurn2 = document.getElementById('opponent-turn-2')
        const opponentTurn3 = document.getElementById('opponent-turn-3')

        opponentTurn1.setAttribute('player-id', opponentId1)
        opponentTurn2.setAttribute('player-id', opponentId2)
        opponentTurn3.setAttribute('player-id', opponentId3)

        for (let i = 0; i < 13 ; i += 1) {
          const opponent1Card = document.createElement('img')
          const opponent2Card = document.createElement('img')
          const opponent3Card = document.createElement('img')

          opponent1Card.classList.add('opponent1-card')
          opponent1Card.src = 'assets/cards/cardback.jpg'
          opponent1Card.setAttribute('draggable', false)
          opponentDeck1.appendChild(opponent1Card)

          opponent2Card.classList.add('opponent2-card')
          opponent2Card.src = 'assets/cards/cardback.jpg'
          opponent2Card.setAttribute('draggable', false)
          opponentDeck2.appendChild(opponent2Card)

          opponent3Card.classList.add('opponent3-card')
          opponent3Card.src = 'assets/cards/cardback.jpg'
          opponent3Card.setAttribute('draggable', false)
          opponentDeck3.appendChild(opponent3Card)
        }

        const opponentName1 = document.getElementById('opponent-name-1')
        const opponentName2 = document.getElementById('opponent-name-2')
        const opponentName3 = document.getElementById('opponent-name-3')

        opponentName1.innerHTML = players.find(p => p.id === opponentId1).name
        opponentName2.innerHTML = players.find(p => p.id === opponentId2).name
        opponentName3.innerHTML = players.find(p => p.id === opponentId3).name
      })

      socket.on('handPlayed', data => {
        const {
          cards,
          playerId
        } = data

        const ground = document.getElementById('ground')

        while (ground.firstChild) ground.removeChild(ground.firstChild)

        cards.map(card => {
          const cardElement = document.createElement('div')
          cardElement.classList.add('card')

          const cardImageElement = document.createElement('img')
          cardImageElement.classList.add('card-image')
          cardImageElement.src = 'assets/cards/' + mapCardToAsset(card) + '.jpg'
          cardImageElement.setAttribute('draggable', false)
          cardElement.appendChild(cardImageElement)

          ground.appendChild(cardElement)
        })

        if (playerId === player.id) {
          selectedCards = []

          cards.map(card => {
            const playerCard = player.cards.find(pCard => pCard.category === card.category && pCard.value === card.value)
            const cardIndex = player.cards.indexOf(playerCard)

            player.cards.splice(cardIndex, 1)

            const cardElement = document.getElementById(card.category + card.value)
            const playerDeck = document.getElementById('player-deck')
            playerDeck.removeChild(cardElement)
          })
        } else {
          const opponentDeck = document.querySelector(".deck[player-id='" + playerId + "']")
          cards.map(card => {
            opponentDeck.removeChild(opponentDeck.childNodes[0])
          })
        }
      })

      socket.on('playerTurn', playerId => {
        const getTurnElement = () => {
          if (playerTurnId == player.id) {
            return document.getElementById('player-turn')
          }

          return document.querySelector(".turn[player-id='" + playerTurnId + "']")
        }

        if (playerTurnId) {
          getTurnElement().classList.add('display-none')
        }

        playerTurnId = playerId

        getTurnElement().classList.remove('display-none')
      })
    </script>

    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <input id="name-input" type="text" placeholder="Enter your name">
    <button onclick="join()">Join</button>

    <div id="player-deck" class="deck"></div>
    <div id="player-name"></div>
    <div id="player-turn" class="turn display-none">T</div>
    <div class="action-btns">
      <div id="pass-btn" onclick="pass()">Pass</div>
      <div id="play-btn" onclick="playHand()">Play</div>
    </div>

    <div id="opponent-deck-1" class="deck"></div>
    <div id="opponent-name-1"></div>
    <div id="opponent-turn-1" class="turn display-none">T</div>

    <div id="opponent-deck-2" class="deck"></div>
    <div id="opponent-name-2"></div>
    <div id="opponent-turn-2" class="turn display-none">T</div>

    <div id="opponent-deck-3" class="deck"></div>
    <div id="opponent-name-3"></div>
    <div id="opponent-turn-3" class="turn display-none">T</div>

    <div id="ground"></div>

    <script src="dragSwap.js"></script>
  </body>
</html>