<html>
  <head>
    <title>Chinese Poker</title>
    <script src="socket.io.js"></script>
    <script src="fetch.js"></script>
    <script src="cardMap.js"></script>
    <script src="cardSelect.js"></script>
    <script src="actions.js"></script>
    <script>
      const host = 'http://localhost:3000'
      const socket = io(host)

      let player = null

      const join = () => {
        const name = document.getElementById('name-input').value

        if (!name) {
          alert('enter name before you join')
          return
        }

        socket.emit('join', name)
      }

      socket.on('joined', playerInfo => {
        player = playerInfo
      })

      socket.on('gameStarted', () => {
        fetchAsync(host + '/player/' + player.id).then(playerInfo =>  {
          player = playerInfo

          const ownCards = document.getElementById('own-cards')
          for (let i in player.cards) {
            const card = player.cards[i]

            const cardElement = document.createElement('div')
            cardElement.classList.add('card')
            cardElement.setAttribute('id', card.category + card.value)
            cardElement.setAttribute('draggable', true)
            cardElement.addEventListener('dragstart', onCardDragStart)
            cardElement.addEventListener('dragover', onCardDragOver)
            cardElement.addEventListener('click', e => {
              toggleSelectCard(card, cardElement)
            })

            const cardImageElement = document.createElement('img')
            cardImageElement.classList.add('card-image')
            cardImageElement.src = 'assets/cards/' + mapCardToAsset(card) + '.jpg'
            cardImageElement.setAttribute('draggable', false)
            cardElement.appendChild(cardImageElement)

            ownCards.appendChild(cardElement)
          }
        })

        document.getElementById('player-name').innerHTML = player.name
      })

      socket.on('handPlayed', data => {
        const {
          cards,
          playerId
        } = data

        const ground = document.getElementById('ground')

        while (ground.firstChild) ground.removeChild(ground.firstChild)

        cards.map(card => {
          const cardElement = document.createElement('div')
          cardElement.classList.add('card')

          const cardImageElement = document.createElement('img')
          cardImageElement.classList.add('card-image')
          cardImageElement.src = 'assets/cards/' + mapCardToAsset(card) + '.jpg'
          cardImageElement.setAttribute('draggable', false)
          cardElement.appendChild(cardImageElement)

          ground.appendChild(cardElement)
        })

        if (playerId === player.id) {
          selectedCards = []

          cards.map(card => {
            const playerCard = player.cards.find(pCard => pCard.category === card.category && pCard.value === card.value)
            const cardIndex = player.cards.indexOf(playerCard)

            player.cards.splice(cardIndex, 1)

            const cardElement = document.getElementById(card.category + card.value)
            const ownCards = document.getElementById('own-cards')
            ownCards.removeChild(cardElement)
          })
        }
      })
    </script>

    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <input id="name-input" type="text" placeholder="Enter your name">
    <button onclick="join()">Join</button>

    <div id="own-cards" class="cards"></div>
    <div class="action-btns">
      <div id="pass-btn" onclick="pass()">Pass</div>
      <div id="play-btn" onclick="playHand()">Play</div>
    </div>
    <div id="player-name"></div>

    <div id="ground"></div>

    <script src="dragSwap.js"></script>
  </body>
</html>