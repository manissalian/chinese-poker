<html>
  <head>
    <title>Chinese Poker</title>
    <script src="socket.io.js"></script>
    <script src="fetch.js"></script>
    <script src="cardMap.js"></script>
    <script src="cardSelect.js"></script>
    <script src="actions.js"></script>
    <script>
      const host = 'http://localhost:3000'
      const socket = io(host)

      let playerName = null
      let roomId = null

      let player = null
      let selectedCards = []
      let playerTurnId = null

      const login = () => {
        const nameValue = document.getElementById('name-input').value

        if (!nameValue) {
          alert('Enter a name before you join.')
          return
        }

        playerName = nameValue
        socket.emit('login', playerName)
      }

      const quit = () => {
        socket.emit('quit', roomId)

        const roomElement = document.getElementById('room')
        roomElement.classList.add('display-none')

        const lobbyElement = document.getElementById('lobby')
        lobbyElement.classList.remove('display-none')
      }

      socket.on('requireLogin', () => {
        const loginElement = document.getElementById('login')
        loginElement.classList.remove('display-none')
      })

      socket.on('uniqueLoginError', () => {
        alert('A user with that name is already connected, choose another.')
      })

      socket.on('passToLobby', rooms => {
        const loginElement = document.getElementById('login')
        loginElement.classList.add('display-none')

        const lobbyElement = document.getElementById('lobby')
        lobbyElement.classList.remove('display-none')

        rooms.map(room => {
          const roomsElement = document.getElementById('rooms')

          const roomElement = document.createElement('div')
          roomElement.classList.add('room')

          const titleElement = document.createElement('div')
          titleElement.innerHTML = 'Room #' + room.id
          roomElement.appendChild(titleElement)

          const listElement = document.createElement('ol')
          listElement.setAttribute('id', room.id)
          room.users.map(user => {
            const userElement = document.createElement('li')
            userElement.setAttribute('name', user.name)
            userElement.innerHTML = user.name
            listElement.appendChild(userElement)
          })
          roomElement.appendChild(listElement)

          const buttonElement = document.createElement('button')
          buttonElement.innerHTML = 'Join'
          buttonElement.addEventListener('click', () => {
            socket.emit('joinRoom', {
              roomId: room.id,
              name: playerName
            })
          })
          roomElement.appendChild(buttonElement)

          roomsElement.appendChild(roomElement)
        })
      })

      socket.on('userJoinedRoomUpdateLobby', data => {
        if (!playerName) return

        const {
          roomId,
          name
        } = data

        const listElement = document.querySelector("ol[id='" + roomId + "']")
        const userElement = document.createElement('li')
        userElement.setAttribute('name', name)
        userElement.innerHTML = name
        listElement.appendChild(userElement)
      })

      socket.on('userQuitUpdateLobby', data => {
        if (!playerName) return

        const {
          roomId,
          name
        } = data

        const listElement = document.querySelector("ol[id='" + roomId + "']")
        const userElement = document.querySelector("li[name='" + name + "']")
        if (userElement) {
          listElement.removeChild(userElement)
        }
      })

      socket.on('joinedRoom', _roomId => {
        roomId = _roomId

        const loginElement = document.getElementById('login')
        loginElement.classList.add('display-none')

        const lobbyElement = document.getElementById('lobby')
        lobbyElement.classList.add('display-none')

        const roomElement = document.getElementById('room')
        roomElement.classList.remove('display-none')

        document.getElementById('player-name').innerHTML = playerName
      })

      socket.on('gameReset', data => {
        const {
          roomId,
          name
        } = data

        if (name) {
          const announcement = document.getElementById('announcement')
          announcement.innerHTML = name + ' has quit. The game ends.'
          announcement.classList.remove('display-none')
        }

        const listElement = document.querySelector("ol[id='" + roomId + "']")
        while (listElement.firstChild) listElement.removeChild(listElement.firstChild)
      })

      // gameroom / gameplay

      socket.on('roundStarted', players => {
        player = players.find(p => p.name === playerName)

        const playerDeck = document.getElementById('player-deck')

        while (playerDeck.firstChild) playerDeck.removeChild(playerDeck.firstChild)

        for (let i in player.cards) {
          const card = player.cards[i]

          const cardElement = document.createElement('div')
          cardElement.classList.add('card')
          cardElement.setAttribute('id', card.category + card.value)
          cardElement.setAttribute('draggable', true)
          cardElement.addEventListener('dragstart', onCardDragStart)
          cardElement.addEventListener('dragover', onCardDragOver)
          cardElement.addEventListener('click', e => {
            toggleSelectCard(card, cardElement)
          })

          const cardImageElement = document.createElement('img')
          cardImageElement.classList.add('card-image')
          cardImageElement.src = 'assets/cards/' + mapCardToAsset(card) + '.jpg'
          cardImageElement.setAttribute('draggable', false)
          cardElement.appendChild(cardImageElement)

          playerDeck.appendChild(cardElement)
        }

        document.getElementById('player-score').innerHTML = 'Score: ' + player.score

        const opponentId1 = player.id === 4 ? 1 : player.id + 1
        const opponentId2 = opponentId1 === 4 ? 1 : opponentId1 + 1
        const opponentId3 = opponentId2 === 4 ? 1 : opponentId2 + 1

        const opponentDeck1 = document.getElementById('opponent-deck-1')
        const opponentDeck2 = document.getElementById('opponent-deck-2')
        const opponentDeck3 = document.getElementById('opponent-deck-3')

        opponentDeck1.setAttribute('player-id', opponentId1)
        opponentDeck2.setAttribute('player-id', opponentId2)
        opponentDeck3.setAttribute('player-id', opponentId3)

        const opponentTurn1 = document.getElementById('opponent-turn-1')
        const opponentTurn2 = document.getElementById('opponent-turn-2')
        const opponentTurn3 = document.getElementById('opponent-turn-3')

        opponentTurn1.setAttribute('player-id', opponentId1)
        opponentTurn2.setAttribute('player-id', opponentId2)
        opponentTurn3.setAttribute('player-id', opponentId3)

        while (opponentDeck1.firstChild) opponentDeck1.removeChild(opponentDeck1.firstChild)
        while (opponentDeck2.firstChild) opponentDeck2.removeChild(opponentDeck2.firstChild)
        while (opponentDeck3.firstChild) opponentDeck3.removeChild(opponentDeck3.firstChild)

        for (let i = 0; i < 13 ; i += 1) {
          const opponent1Card = document.createElement('img')
          const opponent2Card = document.createElement('img')
          const opponent3Card = document.createElement('img')

          opponent1Card.classList.add('opponent1-card')
          opponent1Card.src = 'assets/cards/cardback.jpg'
          opponent1Card.setAttribute('draggable', false)
          opponentDeck1.appendChild(opponent1Card)

          opponent2Card.classList.add('opponent2-card')
          opponent2Card.src = 'assets/cards/cardback.jpg'
          opponent2Card.setAttribute('draggable', false)
          opponentDeck2.appendChild(opponent2Card)

          opponent3Card.classList.add('opponent3-card')
          opponent3Card.src = 'assets/cards/cardback.jpg'
          opponent3Card.setAttribute('draggable', false)
          opponentDeck3.appendChild(opponent3Card)
        }

        const opponentName1 = document.getElementById('opponent-name-1')
        const opponentName2 = document.getElementById('opponent-name-2')
        const opponentName3 = document.getElementById('opponent-name-3')

        opponentName1.innerHTML = players.find(p => p.id === opponentId1).name
        opponentName2.innerHTML = players.find(p => p.id === opponentId2).name
        opponentName3.innerHTML = players.find(p => p.id === opponentId3).name

        const opponentScore1 = document.getElementById('opponent-score-1')
        const opponentScore2 = document.getElementById('opponent-score-2')
        const opponentScore3 = document.getElementById('opponent-score-3')

        opponentScore1.innerHTML = 'Score: ' + players.find(p => p.id === opponentId1).score
        opponentScore2.innerHTML = 'Score: ' + players.find(p => p.id === opponentId2).score
        opponentScore3.innerHTML = 'Score: ' + players.find(p => p.id === opponentId3).score

        const ground = document.getElementById('ground')

        while (ground.firstChild) ground.removeChild(ground.firstChild)
      })

      socket.on('handPlayed', data => {
        const {
          cards,
          playerId
        } = data

        const ground = document.getElementById('ground')

        while (ground.firstChild) ground.removeChild(ground.firstChild)

        cards.map(card => {
          const cardElement = document.createElement('div')
          cardElement.classList.add('card')

          const cardImageElement = document.createElement('img')
          cardImageElement.classList.add('card-image')
          cardImageElement.src = 'assets/cards/' + mapCardToAsset(card) + '.jpg'
          cardImageElement.setAttribute('draggable', false)
          cardElement.appendChild(cardImageElement)

          ground.appendChild(cardElement)
        })

        if (playerId === player.id) {
          selectedCards = []

          cards.map(card => {
            const playerCard = player.cards.find(pCard => pCard.category === card.category && pCard.value === card.value)
            const cardIndex = player.cards.indexOf(playerCard)

            player.cards.splice(cardIndex, 1)

            const cardElement = document.getElementById(card.category + card.value)
            const playerDeck = document.getElementById('player-deck')
            playerDeck.removeChild(cardElement)
          })
        } else {
          const opponentDeck = document.querySelector(".deck[player-id='" + playerId + "']")
          cards.map(card => {
            opponentDeck.removeChild(opponentDeck.childNodes[0])
          })
        }
      })

      socket.on('playerTurn', playerId => {
        const getTurnElement = () => {
          if (playerTurnId == player.id) {
            return document.getElementById('player-turn')
          }

          return document.querySelector(".turn[player-id='" + playerTurnId + "']")
        }

        if (playerTurnId) {
          getTurnElement().classList.add('display-none')
        }

        playerTurnId = playerId

        getTurnElement().classList.remove('display-none')
      })

      socket.on('roundComplete', winner => {
        const announcement = document.getElementById('announcement')
        announcement.innerHTML = winner.name + ' wins this round!'
        announcement.classList.remove('display-none')

        setTimeout(() => {
          announcement.classList.add('display-none')
        }, 5000)
      })

      socket.on('gameComplete', winner => {
        const announcement = document.getElementById('announcement')
        announcement.innerHTML = winner.name + ' wins the game!!!'
        announcement.classList.remove('display-none')
      })
    </script>

    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div id="login" class="display-none">
      <input id="name-input" type="text" placeholder="Enter your name">
      <button id="login-btn" onclick="login()">Join</button>
    </div>

    <div id="lobby" class="display-none">
      <h1>Chinese Poker</h1>
      <h2>Welcome to the lobby!</h2>
      <h3>Join a room to start playing! The game will start when 4 players join in the room.</h3>
      <div id="rooms"></div>
    </div>

    <div id="room" class="display-none">
      <div id="player-deck" class="deck"></div>
      <div id="player-name"></div>
      <div id="player-turn" class="turn display-none">T</div>
      <div id="player-score"></div>
      <div class="action-btns">
        <div id="pass-btn" onclick="pass()">Pass</div>
        <div id="play-btn" onclick="playHand()">Play</div>
      </div>

      <div id="opponent-deck-1" class="deck"></div>
      <div id="opponent-name-1"></div>
      <div id="opponent-turn-1" class="turn display-none">T</div>
      <div id="opponent-score-1"></div>

      <div id="opponent-deck-2" class="deck"></div>
      <div id="opponent-name-2"></div>
      <div id="opponent-turn-2" class="turn display-none">T</div>
      <div id="opponent-score-2"></div>

      <div id="opponent-deck-3" class="deck"></div>
      <div id="opponent-name-3"></div>
      <div id="opponent-turn-3" class="turn display-none">T</div>
      <div id="opponent-score-3"></div>

      <div id="ground"></div>

      <div id="announcement" class="display-none"></div>

      <button id="quit" onclick="quit()">Quit Game</button>
    </div>

    <script src="dragSwap.js"></script>
  </body>
</html>